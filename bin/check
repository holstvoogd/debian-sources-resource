#!/bin/sh
set -eu -o pipefail
exec 3>&1 1>&2

jq . < /dev/stdin > /tmp/input

ARCH=$(jq -r '.source.arch // "amd64"' < /tmp/input)

touch --date="$(jq -r '.version.updated // "now"' < /tmp/input)" /tmp/last

jq -r '.source.sources[]' < /tmp/input | while read SOURCE; do
  URI=$(expr match "$SOURCE" 'deb \([^ ]*\)')
  SUITE=$(expr match "$SOURCE" "deb $URI \([^ ]*\)")
  COMPONENTS=$(expr match "$SOURCE" "deb $URI $SUITE \(.*\)")

  for COMP in $COMPONENTS; do
    curl --silent --head --time-cond /tmp/last --remote-time --output /tmp/curl \
      "$URI/dists/$SUITE/$COMP/binary-$ARCH/Release"
    if grep -q '^HTTP/... 200 ' /tmp/curl; then
      touch --reference=/tmp/curl /tmp/last
    fi
  done
done

echo '[{"updated":"'$(date --reference=/tmp/last --rfc-2822)'"}]' >&3
